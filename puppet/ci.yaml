# Puppet CI Resources

classes:
  - nsidc_jenkins
  - nsidc_miniconda

nsidc_miniconda::install:
  /opt/miniconda:
    version: '4.3.27'
    owner: vagrant
    group: vagrant
    build: true
    config:
      location: /home/vagrant
      channels:
        anaconda_nsidc_main: true
        anaconda_nsidc_dev: true
        conda_forge: true
    packages:
    - bumpversion==0.5.3

# Jenkins Plugins
nsidc_jenkins::plugins:
  xvnc: {}
  simple-theme-plugin: {}
  parameterized-trigger:
    version: 2.25

# Jenkins Jobs
nsidc_jenkins::jobs:
  "%{hiera('project')}_A01_Checkout_Project":
    description: clone the project into workspaces/%{hiera('project')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}
    parameters:
      - type: string
        name: ref
        description: git ref (branch, tag, or SHA) to checkout
        default: master
      - type: choice
        name: target_environment
        description: The VM environment to deploy to
        choices:
          - integration
          - qa
          - staging
          - blue
    git:
      repo: "%{hiera('gitrepo')}"
      poll_scm: true
    command: |
      git checkout $ref
    triggers:
      - jobs:
          - "%{hiera('project')}_A02_Provision_VM"
        parameters:
          current_build_parameters: true

  "%{hiera('project')}_A02_Provision_VM":
    description: >
      Provision an integration, QA, staging, or production VM for Hermes
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}
    parameters:
      - type: string
        name: target_environment
        description: VM environment to build
        default: "integration"
    command: |
      #!/bin/bash
      vagrant nsidc hijack --force --env=$target_environment || true
      vagrant nsidc up --env=$target_environment --provision
      vagrant nsidc ssh --env=$target_environment -c "sudo service hermes restart"

  "%{hiera('project')}_Z01_Integration_Refresh_Portal":
    description: >
      Pull new images and rebuild and restart portal in integration
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}
    command: |
      #!/bin/bash
      vagrant nsidc hijack --force --env=integration
      vagrant nsidc ssh --env=integration -c "cd /vagrant/docker-compose && docker pull nsidc/hermes-interface && docker pull nsidc/hermes-services && docker pull nsidc/hermes-workers && sudo service hermes restart"

  "%{hiera('project')}_Create_Release":
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/release
    git:
      repo: "%{hiera('gitrepo')}"
    parameters:
      - type: string
        name: ref
        description: git ref (branch, tag, commit SHA) to checkout
        default: master
      - type: choice
        name: version_part
        description: The part of the version to increase, according to SemVer.
        choices:
          - patch
          - minor
          - major
    command: |
      git checkout $ref
      bumpversion $version_part
      git push
      git push --tags
