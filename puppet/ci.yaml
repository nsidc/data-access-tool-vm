# Puppet CI Resources

classes:
  - nsidc_jenkins

# Jenkins Plugins
nsidc_jenkins::plugins:
  git: {}
  git-client: {}
  git-parameter: {}
  scm-api: {}
  credentials: {}
  ssh-credentials: {}
  greenballs: {}
  jobConfigHistory: {}
  mailer: {}
  instant-messaging: {}
  jabber: {}
  xvnc: {}
  ansicolor: {}

# Jenkins Jobs
nsidc_jenkins::jobs:
  "%{hiera('project')}_A01_Checkout_Project":
    description: clone the project into workspaces/%{hiera('project')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}
    parameters:
      - type: string
        name: ref
        description: git ref (branch, tag, or SHA) to checkout
        default: master
    git:
      repo: "%{hiera('gitrepo')}"
      poll_scm: true
    command: |
      git checkout $ref
    trigger_job: "%{hiera('project')}_A02_Provision_VM"

  "%{hiera('project')}_A02_Provision_VM":
    description: >
      Provision an integration, QA, staging, or production VM for IceBridge
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}
    parameters:
      - type: string
        name: target_environment
        description: VM environment to build
        default: "integration"
    command: |
      vagrant nsidc hijack --env=$target_environment || true
      vagrant nsidc up --env=$target_environment --provision